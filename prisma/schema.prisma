// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  // url dans ton .env : DATABASE_URL="postgresql://user:pass@host:port/db"
}

enum Rarity {
  COMMON
  UNCOMMON
  RARE
  VERY_RARE
  LEGENDARY
  STORY
}

enum ItemStatus {
  TO_GET // à récupérer
  IN_PROGRESS // en cours (optionnel)
  OBTAINED // récupéré
}

enum ItemType {
  AMULET
  ARMOR
  CLOAK
  BOOTS
  GLOVES
  HELMET
  RING
  WEAPON
  OFFHAND
  RANGED_WEAPON
  INSTRUMENT
}

enum SourceType {
  MERCHANT
  QUEST
  POI
}

model Run {
  id          Int     @id @default(autoincrement())
  name        String
  description String?

  runCharacters  RunCharacter[]
  characterItems CharacterItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model Character {
  id       Int     @id @default(autoincrement())
  name     String
  classe   String?
  subclass String?
  image    String?

  runs      RunCharacter[]
  items     CharacterItem[]
  createdAt DateTime        @default(now())
  updatedAt DateTime        @default(now()) @updatedAt
}

// Table de liaison entre Run et Character
model RunCharacter {
  id Int @id @default(autoincrement())

  run         Run       @relation(fields: [runId], references: [id], onDelete: Cascade)
  runId       Int
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  characterId Int

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@unique([runId, characterId], name: "uniq_character_per_run")
}

model Item {
  id   Int      @id @default(autoincrement())
  name String
  type ItemType
  act  Int // 1, 2 ou 3

  // Source principale de l'item
  sourceType SourceType

  // Relations optionnelles vers les entités de source
  merchant   Merchant? @relation(fields: [merchantId], references: [id])
  merchantId Int?

  quest   Quest? @relation(fields: [questId], references: [id])
  questId Int?

  poi   Poi? @relation(fields: [poiId], references: [id])
  poiId Int?

  // Optionnels
  image       String?
  description String?
  rarity      Rarity?
  wikiLink    String?

  characterItems CharacterItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  npc       Npc?     @relation(fields: [npcId], references: [id])
  npcId     Int?
}

model CharacterItem {
  id Int @id @default(autoincrement())

  // On dénormalise le run ici pour pouvoir poser une contrainte au niveau DB
  run   Run @relation(fields: [runId], references: [id], onDelete: Cascade)
  runId Int

  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  characterId Int

  item   Item @relation(fields: [itemId], references: [id], onDelete: Cascade)
  itemId Int

  status    ItemStatus @default(TO_GET)
  note      String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @default(now()) @updatedAt

  // Empêche qu'un même item soit assigné à plusieurs personnages dans la même run
  @@unique([runId, itemId], name: "uniq_item_per_run")
}

// === Nouvelles entités de source ===

model Merchant {
  id       Int     @id @default(autoincrement())
  name     String
  act      Int // acte où il se trouve
  pos_x    Int? // zone / description
  pos_y    Int?
  wikiLink String?
  image    String?

  items     Item[]
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model Quest {
  id       Int     @id @default(autoincrement())
  name     String
  act      Int
  npcId    Int? // npc qui donne la récompense
  phase    String? // étape, sous-phase, etc.
  wikiLink String?
  image    String?

  items     Item[]
  npc       Npc?     @relation(fields: [npcId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model Poi {
  id       Int     @id @default(autoincrement())
  name     String
  act      Int
  pos_x    Int? // zone / description
  pos_y    Int?
  wikiLink String?
  image    String?

  items     Item[]
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

// === Nouvelle entité Boss / NPC De quêtes ===
model Npc {
  id       Int     @id @default(autoincrement())
  name     String
  act      Int
  pos_x    Int? // zone / description
  pos_y    Int?
  wikiLink String?
  image    String?

  items     Item[]
  quests    Quest[]
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}
